<div class="profile">
  <app-card [header]="true" [title]="'profile.title' | translate">
    @if (loading()) {
    <div class="profile__loading">
      {{ 'profile.loading' | translate }}
    </div>
    }

    @if (!loading()) {
    <form [formGroup]="profileForm" (ngSubmit)="onSubmit()" class="profile__form">

      <div class="profile__header">
        <div class="profile__header-avatar-wrapper group">
          <div class="profile__header-avatar">
            @if (profileForm.get('avatar_url')?.value) {
            <img [src]="profileForm.get('avatar_url')?.value">
            } @else {
            <span>{{ (profile()?.username?.charAt(0) || '?') | uppercase }}</span>
            }
          </div>
        </div>

        <div class="profile__header-info">
          <h3>{{ profile()?.username }}</h3>
          <p>{{ authService.user()?.email }}</p>
        </div>
      </div>

      <hr class="profile__divider" />

      <div class="profile__avatar-selection">
        <label>Choose an Avatar</label>
        <div class="profile__avatar-selection-grid">
          @for (mask of masks; track mask.url) {
          <button type="button" (click)="selectAvatar(mask.url)" class="profile__avatar-selection-button" [ngClass]="{
                        'profile__avatar-selection-button--selected': profileForm.get('avatar_url')?.value === mask.url,
                        'profile__avatar-selection-button--unselected': profileForm.get('avatar_url')?.value !== mask.url
                      }">
            <img [src]="mask.url" [alt]="mask.name">
            @if (profileForm.get('avatar_url')?.value === mask.url) {
            <div class="profile__avatar-selection-button-overlay">
              <div>
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none"
                  stroke="currentColor" stroke-width="4" stroke-linecap="round" stroke-linejoin="round">
                  <polyline points="20 6 9 17 4 12" />
                </svg>
              </div>
            </div>
            }
          </button>
          }
        </div>
      </div>

      <hr class="profile__divider" />

      <div class="profile__fields">
        <app-input formControlName="display_name" [label]="'profile.displayName' | translate"
          [placeholder]="'profile.displayNamePlaceholder' | translate"></app-input>

        <div class="profile__fields-row">
          <app-input formControlName="theriotype" [label]="'profile.theriotype' | translate"
            [placeholder]="'profile.theriotypePlaceholder' | translate"></app-input>

          <app-input formControlName="pronouns" [label]="'profile.pronouns' | translate"
            [placeholder]="'profile.pronounsPlaceholder' | translate"></app-input>
        </div>

        <div class="profile__field">
          <label>{{ 'profile.bio' | translate }}</label>
          <textarea formControlName="bio" [placeholder]="'profile.bioPlaceholder' | translate"></textarea>
        </div>

        <div class="profile__field">
          <label>{{ 'profile.explorationStatus' | translate }}</label>
          <div class="profile__select-wrapper">
            <select formControlName="exploration_status">
              <option value="exploring">{{ 'profile.exploring' | translate }}</option>
              <option value="defined">{{ 'profile.defined' | translate }}</option>
              <option value="prefer_not_say">{{ 'profile.preferNotSay' | translate }}</option>
            </select>
            <!-- Custom chevron -->
            <div class="profile__select-wrapper-icon">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="m6 9 6 6 6-6" />
              </svg>
            </div>
          </div>
        </div>
      </div>

      @if (message()) {
      <div class="profile__message"
        [ngClass]="messageType() === 'success' ? 'profile__message--success' : 'profile__message--error'">
        @if (messageType() === 'success') {
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" />
          <polyline points="22 4 12 14.01 9 11.01" />
        </svg>
        }
        @if (messageType() === 'error') {
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="12" r="10" />
          <line x1="15" y1="9" x2="9" y2="15" />
          <line x1="9" y1="9" x2="15" y2="15" />
        </svg>
        }
        {{ message() }}
      </div>
      }

      <div class="profile__actions">
        <app-button type="submit" variant="primary" size="lg" [disabled]="saving()">
          @if (saving()) {
          <span class="profile__saving">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor"
                d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
              </path>
            </svg>
            {{ 'profile.saving' | translate }}
          </span>
          } @else {
          <span>{{ 'profile.saveChanges' | translate }}</span>
          }
        </app-button>
      </div>
    </form>
    }
  </app-card>
</div>